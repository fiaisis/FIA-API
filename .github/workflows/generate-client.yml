name: Generate API Client

on: push

permissions:
  contents: write

jobs:
  generate-client:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: fia
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v3.5.0

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v4.5.0
        with:
          python-version: "3.12"

      - name: Set up cache for Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install API dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install .

      - name: Install client generation dependencies
        run: |
          python -m pip install ".[client-generation]"

      - name: Start FIA API in background
        run: |
          uvicorn fia_api.fia_api:app --host 0.0.0.0 --port 8000 &
          # Wait for API to start
          sleep 10

      - name: Generate client code
        run: |
          # Generate the client code
          openapi-python-client generate --url http://localhost:8000/openapi.json
          # Move generated files to fia_api_client directory if needed
          if [ -d "fia-api-client" ]; then
            cp -r fia-api-client/* fia_api_client/
            rm -rf fia-api-client
          fi

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add fia_api_client/
          git commit -m "Update API client based on latest OpenAPI schema" || echo "No changes to commit"
          git push
