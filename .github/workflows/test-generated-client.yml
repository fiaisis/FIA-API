---
name: Run Tests on Autogenerated Client
on: push

permissions:
  contents: read
  packages: read

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:14.7
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: fia
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - name: Checkout project
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v3.5.0

      - name: Set up python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v4.5.0
        with:
          python-version: "3.12"

      - name: Set up cache for Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies.
        run: |
          python -m pip install --upgrade pip
          python -m pip install .[test]
    
      - name: Install client generation dependencies
        run: | 
          python -m pip install ".[client-generation]"

      - name: Start FIA API in background
        run: |
          uvicorn fia_api.fia_api:app --host 0.0.0.0 --port 8000 &
          # Wait for API to start
          sleep 10

      - name: Generate client code
        run: |
          openapi-python-client generate --url http://localhost:8000/openapi.json --overwrite

      - name: Run pytest
        env:
          DATABASE_URL: postgresql://postgres:password@localhost:5432/test_db
          GITHUB_PACKAGE_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: pytest test/core/test_autogenerated_client.py


